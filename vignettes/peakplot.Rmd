---
title: "20161216_CHE434 live demo"
author: "Christian Panse"
date: "12/12/2016"

output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

random_swap <- function(x){
   a <- sample(length(x),2)
   tmp <- x[a[1]]
   x[a[1]] <- x[a[2]]
   x[a[2]] <- tmp
  
   return(x)
   }
```

# FASTA - get current SwissProt

```bash
curl ftp://ftp.uniprot.org/pub/databases/uniprot/\
current_release/knowledgebase/complete/uniprot_sprot.fasta.gz \
| gunzip -c \
> swissprot
```

# Top ten organisms having the largest number of entries in swissprot
```base
grep "^>" < swissprot \
| awk '$1~/_/{print $1}' \
| awk -F"_" '{h[$NF]++}END{for (i in h){print i" "h[i]}}' \
| sort -k2 -g -r -S128M \
| head -n 10
```

# MS detectable peptides

tryptic digest rule: cut after R or K if the C-term. residue is not P.
```bash
grep "^>sp|P21781|FGF7_HUMAN" -A 5 < swissprot \
| fcat \
| digest \
| pim  \
| awk -F";" '600<$2 && $2<6000{print }'
```


# CRAN package protViz

* install R
http://stat.ethz.ch/CRAN/

* install protViz
https://CRAN.R-project.org/package=protViz

```{R}
library(protViz)
```

# AA
```{r}
AA
```
# Compute fragmention table of 'EGVNDNEEGFFSAR'

```{R}
fragmentIon('TAFDEAIAELDTLNEESYK')
```


# Plot tandem MS

```{R}
#source('F161375_query160.R')
#load("F161375.RData")
#plot(F161375[[160]]$mZ, F161375[[160]]$intensity, type='h')
```

# Label tandem MS

```{r}
data(msms)
```

## TAFDEAIAELDTLNEESYK

```{r fig.retina=3}
rv <- peakplot("TAFDEAIAELDTLNEESYK", msms[[1]])
```

## TAFDEAIAELDTLSEESYK

```{r fig.retina=3}
rv <- peakplot("TAFDEAIAELDTLSEESYK", msms[[2]])


#peakplot(peptide=F161375[[160]]$peptideSequence, 
#         spec=F161375[[160]],
#         FUN=function(b,y){
#           return (list(y=y))
#         })
```


# example

```{r}

byIon <- function(b, y){
    Hydrogen <- 1.007825
    Oxygen <- 15.994915
    Nitrogen <- 14.003074

    #yo <- fi$y - Oxygen - Hydrogen - Hydrogen
    #c<- b + (Nitrogen + (3 * Hydrogen))
    #z<- y - (Nitrogen + (3 * Hydrogen))
  
    b2_ <- (b + Hydrogen) * 0.5
    y2_ <- (y + Hydrogen) * 0.5

    return(cbind(b, y, b2_, y2_))
}

peptide_search <- function(x, peptides, 
                           pimIdx=parentIonMass(peptides), 
                           peptideMassTolerancePPM=5,
                           framentIonMassToleranceDa=0.01){
  
  query.mass <- ((x$pepmass  * x$charge))  - (1.007825 * (x$charge-1))
  eps <- query.mass * peptideMassTolerancePPM * 1E-6
  
  lower <- findNN(query.mass - eps, pimIdx)
  upper <- findNN(query.mass + eps, pimIdx)
  
  rv <- mclapply(peptides[lower:upper], function(p){
      psm(p, x, plot=FALSE, FUN=byIon)},mc.cores =4)
  
  rv.error <- sapply(rv, function(p){sum(abs(p$mZ.Da.error) < framentIonMassToleranceDa)})
  
  idx.tophit <- which(rv.error==max(rv.error))[1]
  
  data.frame(mass_error=eps, 
             idxDiff = upper - lower, 
             charge = x$charge, 
             pepmass = query.mass,
             peptideSequence = rv[[idx.tophit]]$sequence,
             ms2hit = (rv[[idx.tophit]]$sequence == x$peptideSequence),
             hit = (x$peptideSequence %in% peptides[lower:upper]))
}

idx <- which(sapply(F244088f, function(x){length(x$mZ)>0}))

S <- do.call('rbind', lapply(F244088f[idx], function(x){peptide_search(x, swissprot_tryptic_peptides10K, pim )}))


```

---
title: "Label Free Quantification (LFQ)"
author: "Christian Panse"
date: "12/12/2016"

output: slidy_presentation
---

```{r}
library(specL)
library(lattice)
```


# consideration

```{r}
P <- read.table("../data/proteotypic_peptides.txt", col.names=c('protein','peptide','pim'))
load("data/F244088f.RData")
```

# plot filtered LCMS map
```{r}
plot.psmSet(F244088f)
```

```{r fig.retina=3}
# xyplot(pim ~ ssrc | protein, group=protein, data=P)
```

## xic

```{r}
load("data/xic.RData")
XIC.max <- aggregate(count ~ protein + peptide + charge, data=XIC, FUN=max)
XIC.max <- merge(XIC, XIC.max, by.x=names(XIC.max), by.y = names(XIC.max))
```

## RT normalization


# Two Group
```{r}
S <- read.table("../data/p1946_prx.tsv", sep='\t', header=TRUE)
gg <- c(rep('G', 6), rep('GE', 6))
dim(S)
table(gg)

op <- par(mfrow=c(1,3))
# example 0
idx <- 2
x <- log(unlist(S[idx,2:13]),2)
boxplot(x ~ gg, main=S[idx,1])
t.test(x ~ gg,  alternative = "two.sided")

# example 1
idx <- which(S$protein == "sp|P00331|ADH2_YEAST")
x <- log(unlist(S[idx,2:13]),2)
boxplot(x ~ gg, main=S[idx,1])
t.test(x ~ gg,  alternative = "two.sided")

#example 2
idx <- which(S$protein == "sp|P33302|PDR5_YEAST")
x <- log(unlist(S[idx,2:13]),2)
boxplot(x ~ gg, main=S[idx,1])
t.test(x ~ gg,  alternative = "two.sided")
```


```{r}
expression_analysis <- function(S, groups){
  S.t.test <- lapply(1:nrow(S), function(idx){
    x <- unlist(S[idx, 2:ncol(S)])
    x[x==0] <- NA
    if (min(aggregate(x, by=list(groups), function(x){sum(!is.na(x))})$x)>5){
      t <- t.test(log(x, 2) ~ groups, alternative = "two.sided")
      cbind(FC = diff(t$estimate), p.value = t$p.value, proteinID=idx)
    }else{NULL}
  })
  
  S.t.test <- as.data.frame(do.call('rbind',S.t.test))
  rownames(S.t.test) <- substr(S[S.t.test$proteinID,1], 1, 20)
    #paste(1:nrow(S.t.test), substr(S[S.t.test$proteinID,1], 1, 9), sep="_")
  S.t.test
}


S.t.test <- expression_analysis(S, gg)
head(S.t.test)
```

# volcano plot - p.value vs FC

```{r fig.retina=3}
plot_volcano <- function(S.t.test){
  plot(-log(p.value,10) ~ FC, data=S.t.test, 
       main="volcano plot",
       sub="p1946 prx")
  abline(v=c(-0.5,0.5), col='grey')
  abline(h=-log(0.025, 10), col='grey')
  
  points(-log(p.value,10) ~ FC, 
         data=S.t.test[abs(S.t.test$FC)>0.5 & S.t.test$p.value<0.025,], 
         col='red',cex=0.5)
  
  points(-log(p.value,10) ~ FC,
         data=S.t.test[grepl('ZZ', rownames(S.t.test)),],
         col='cyan')
  
  points(-log(p.value,10) ~ FC,
         data=S.t.test[grepl('REV', rownames(S.t.test)),],
         cex=2, lwd=2,
         col='green')
}

plot_volcano(S.t.test)
```

# What happen if you mess up your annotation?
```{r}
random_swap <- function(x){
   a <- sample(length(x),2)
   tmp <- x[a[1]]
   x[a[1]] <- x[a[2]]
   x[a[2]] <- tmp
  
   return(x)
   }
```

```{r fig.retina=5}
op<-par(mfrow=c(2,2))
plot_volcano(S.t.test)
(gg <- random_swap(gg)); S.t.test <- expression_analysis(S, gg); plot_volcano(S.t.test)
(gg <- random_swap(gg)); S.t.test <- expression_analysis(S, gg); plot_volcano(S.t.test)
(gg <- random_swap(gg)); S.t.test <- expression_analysis(S, gg); plot_volcano(S.t.test)
```

* a viewpoint on volcano plot:
Uses and misuses of the fudge factor in
quantitative discovery proteomics, Proteomics 2016, 16, 1955â€“1960 
http://onlinelibrary.wiley.com/doi/10.1002/pmic.201600132/epdf
